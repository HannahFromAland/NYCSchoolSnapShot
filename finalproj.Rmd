--- 
title: "NYC School Snapshot"
author: "Pinyi Yang & Yuan Heng"
date: "`r Sys.Date()`"
site: bookdown::bookdown_site
---
```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```

# Introduction

In our project, we try to use exploratory analysis to answer questions as follows:

* Does the composition of ethnic groups correlate with the poverty rate of the student population? Is it more likely to have a lower poverty rate when the percentage of white students is higher?

* Does the number of total enrolled students correlate with the distribution of ethnic groups? For example, a bigger school has a more even composition of different ethnic groups (i.e. similar percentage for black, Asian, and white)?

* Does the composition of different genders correlate with the school’s poverty level? Do schools that have relatively higher poverty rates have more male students?

* Does the school level(eg. Primary school, middle school, high school) or ethic groups correlates?

* Does the distribution of schools in different districts have relations towards ethnic groups, gender groups and poverty level?

<!--chapter:end:index.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Data sources

```{r, echo=FALSE}
library(knitr)
library(ggplot2)
```

The data sets we are going to use in our analyses come from NYC Department of Education, and is open sourced on NYC Open Data, a popular website with various types of official data sets published by New York City agencies. In the raw dataset of `2013 - 2018 Demographic Snapshot School `, there exists several variables that worth investigating furthermore as follows:

* The data set contains attributes of the **composition of different ethnicity groups** and also one variable that describes the **poverty level** of the whole school (i.e. how many students are classified as poor), thus we can investigate the relationship between ethnicity composition and school’s overall poverty level;

* Since the data set provides the **total number of enrolled students** as well as variables describing the **number of students from each ethnicity**, we can investigate if the total number of students correlates with the relative composition of ethnicity among the student population;

* The data set has descriptions about the **gender composition** of the student population (i.e. number of males and female students in the school). Based on the variable about the **poverty level** of the school and the information about gender composition, we can draw inferences on their interactions;

* Finally, since New York City is a quite certain place for us to narrow down our investigation, we may use the school name to find their locations and districts. By combining the **district information** and the school’s **poverty level**, we can identify the locations where poverty level is relatively high. 


## Descriptive Analysis of Data Source

```{r} 
school = read.csv("School.csv")
kable(colnames(school))
```

The raw data has 8972 observations of 39 variables. Categories variables including `academic years`, `Grades`, `Gender` and `Race`. More importantly, the datasets includes several heuristic metrics variables such as `rate of disability students`, `English language learners`, `Economic need` and `Poverty` to help us dive deeper into relationships between education and other interesting topics.

```{r}
p <- ggplot(data= school, aes(x = Year)) +
  geom_bar(fill = "lightblue",width =0.5) +
  ggtitle("Number of sample from different years")+
  geom_text(stat='count',aes(label=..count..), position = position_dodge(width = 0.9), 
            vjust = -0.4, color = "grey68") +
  theme(plot.title = element_text(hjust = 0.5, face  = "bold", size = 14))
p
```

## Issue with raw data

* The raw data didn't explicitly give out the district or borough where each school locates. Therefore, we have to construct location variables in order to inspect the relationship between school locations and other topics;

* In the raw data, the type of school is not included. However, based on the data shown in different grades, we can conclude whether the school is a primary school, middle school or high school. Therefore, we may use the given information to classify different level of school in data transformation part.

<!--chapter:end:02-data.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Data transformation

<!--chapter:end:03-cleaning.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Missing values
```{r, echo=FALSE}
library(knitr)
library(ggplot2)
setwd("~/Desktop")
NYC <- read.csv("NYC.csv")
bookdown::render_book()
```
We first check if there are any NA values in the dataset:
```{r}
any(is.na(NYC))
```
However, after closer inspection, we saw that there are entries labeled with "No Data". Thus, we need to treat those entries as NAs.
```{r}
NYC_na <- NYC %>%
  na_if("No Data")
any(is.na(NYC_na))
sum(is.na(NYC_na))
sum(is.na(NYC_na))/prod(dim(NYC_na))*100 #in percentage
```
## Missing Pattern plot
```{r}
plot_missing <- function(data, percent = FALSE ){
  missing_patterns <- data.frame(is.na(data)) %>%
    group_by_all() %>%
    count(name = "count", sort = TRUE) %>%
    ungroup() %>%
    remove_rownames() %>%
    rownames_to_column("number") 
  
  missing_patterns_graph<- missing_patterns %>%
    gather(key,value,-c(number,count)) %>%
    group_by(number) %>%
    mutate(complete_case = factor(ifelse(sum(value) == 0, 1, 0.5)))

  if(percent){
    missing_patterns_number <-  missing_patterns_graph %>% 
      group_by(key)%>%
      summarise(missing_number = 100*((sum(value*count))/sum(count)))%>%
      arrange(desc(missing_number)) 
  }
  if(!percent){
    missing_patterns_number <-  missing_patterns_graph %>% 
      group_by(key)%>%
      summarise(missing_number = (sum(value*count))) %>%
      arrange(desc(missing_number))
  }
  
  level_for_order <- (missing_patterns_number$key)

  g1 <- missing_patterns_graph %>%
    ggplot(aes(x = factor(key,level_for_order), 
             y = fct_rev(factor(as.numeric(number))),
             fill = value,alpha = complete_case)) +
    geom_tile(color = "white") + 
    scale_fill_manual(values = c("grey","purple")) +
    scale_alpha_manual(values = c(1,0.5)) +
    annotate("text",x = length(level_for_order)/3,
           y = missing_patterns_graph[missing_patterns_graph$complete_case == 1,]$number,
           label = "Complete Case") +
    theme(legend.position="none") +
    xlab("variable")+
    ylab("missing pattern")

   
  g2 <- missing_patterns %>% 
    group_by(number)%>%
    ggplot(aes(x = reorder(number,count),y = count)) +
    geom_bar(stat="identity") + 
    ylab("row count")+
    coord_flip()+
    theme(axis.title.y=element_blank()) 
 

  g3 <- ggplot(missing_patterns_number,
               aes(x = reorder(key,-missing_number),y = missing_number)) +
    geom_bar(stat="identity") +
    theme(axis.title.x=element_blank(),axis.title.y = element_text(size = 8)) +
    ggtitle("Missing value patterns")

  
  if(percent){
    g3 <- g3 +  ylab("% rows missing") + ylim(0,100)
  }else{
    g3 <- g3 +  ylab("num rows missing")
  }

  g3 + plot_spacer() + g1 +g2+ plot_layout(widths = c(5, 2), 
                                           heights = unit(c(2, 5), c('cm', 'null')))
}
```
Given the shear size of the dataset, it is hard to visualize missing value pattern of the whole dataset, thus, we can sample from the whole data set and visualize the missing pattern:
```{r}
set.seed(1234567)
# case1
row_ind <- sample(1:nrow(NYC_na), 200)
col_ind <- sample(1:ncol(NYC_na), 10)
new_NYC <- NYC_na[row_ind, col_ind]
plot_missing(new_NYC)

# case2
row_ind <- sample(1:nrow(NYC_na), 200)
col_ind <- sample(1:ncol(NYC_na), 10)
new_NYC <- NYC_na[row_ind, col_ind]
plot_missing(new_NYC)

# case3
row_ind <- sample(1:nrow(NYC_na), 200)
col_ind <- sample(1:ncol(NYC_na), 10)
new_NYC <- NYC_na[row_ind, col_ind]
plot_missing(new_NYC)
```
After trying few cases of missing pattern combinations, it is really rare to find a case that have a pattern. This is because that the data itself has a really large size, which is 8972 rows by 39 columns, while there's only 1730 missing entries, with a missing value rate less than 0.5%. Thus, we can say that the data set is overall complete.
check for update

<!--chapter:end:04-missing.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Results

<!--chapter:end:05-results.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Interactive component



<!--chapter:end:06-interactive.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Conclusion


<!--chapter:end:07-conclusion.Rmd-->

