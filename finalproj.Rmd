--- 
title: "NYC School Snapshot"
author: "Pinyi Yang & Yuan Heng"
date: "`r Sys.Date()`"
site: bookdown::bookdown_site
---
```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```

# Introduction
Racial inequality has always been a public problem. In the past few years, there has been multiple incidents relating ethnicity inequalities. For example, George Floyd's tragedy led to a wave of "Black Lives Matter" campaign; the death of Chinese student at Chicago university revealed a series of discriminating activities against Asian international students. Given the prevalent problem presenting in the society, we hypothesized that discrimination originate from poverty levels. Thus, we aim to gain more insights about racial inequalities by investigating the distribution of ethnicity and other indicators in schools in New York. In this way, we can determine if racial inequality exist in some schools, which can allow agencies to make adjustments to bring about equality among students.

Apart from academia purpose of education, making sure schools reflect the diversity of its residents is a top priority. Improving educational equity has long been a focus of society, especially New York City, where public schools remain some of the most segregated in the country. 

> According to the New York City Council, "In New York City public schools, 74.6% of black and Hispanic students attend a school with less than 10% white students. Additionally, 34.3% of white students attend a school with more than 50% white students."

Apart from race and ethnicity, the segregation also can be found among different groups of gender, poverty and even students' disability. Severe discrepancies still exist when breaking down the huge population of students and investigating their access to education and schools. 

In our project, we try to perform exploratory analysis of demographic school data in New York City from 2013- 2018 and answer questions as follows:

* Does the composition of ethnic groups correlate with the poverty rate of the student population? Is it more likely to have a lower poverty rate when the percentage of white students is higher?

* Does the number of total enrolled students correlate with the distribution of ethnic groups? For example, a bigger school has a more even composition of different ethnic groups (i.e. similar percentage for black, Asian, and white)?

* Does the composition of different genders correlate with the school’s poverty level? Do schools that have relatively higher poverty rates have more male students?

* Does the school level(eg. Primary school, middle school, high school) or ethic groups correlates?

* Does the distribution of schools in different districts have relations towards ethnic groups, gender groups and poverty level?

<!--chapter:end:index.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Data sources

```{r, echo=FALSE}
library(knitr)
library(ggplot2)
library(tidyr)
library(tidyverse)
library(dplyr)
```

The data sets we are going to use in our analyses come from NYC Department of Education, and is open sourced on NYC Open Data, a popular website with various types of official data sets published by New York City agencies. The data is presented in a chronological order, from the 2013 academic year to the 2017 academic year, for each school in New York.  

## Exploratory Data Analysis
The raw data has 8972 observations of 39 variables. Categories variables including `academic years`, `Grades`, `Gender` and `Race`. More importantly, the datasets includes several heuristic metrics variables such as `rate of disability students`, `English language learners`, `Economic need` and `Poverty` to help us dive deeper into relationships between education and other interesting topics.

### Data Column Summary Example
```{r} 
school = read.csv("School.csv")
school_cleaned <- school %>%
  select(-c(DBN, X..Students.with.Disabilities, 
            X..Students.with.Disabilities.1, 
            X..English.Language.Learners,
            X..English.Language.Learners.1,
            Economic.Need.Index))
colnames(school_cleaned)[c(4, 18:33)] <- c("Grade.PK", "Female.count", "Female.percentage",
                                           "Male.count", "Male.percentage", "Asian.count",
                                           "Asian.percentage", "Black.count", "Black.percentage",
                                           "Hispanic.count", "Hispanic.percentage", "Other.count",
                                           "Other.percentage", "White.count", "White.percentage",
                                           "Poverty.count", "Poverty.percentage")
#sample data description
kable(summary(school_cleaned[, c("Total.Enrollment", "Grade.K", 
                                 "Grade.12", "Male.count", "Asian.percentage",
                                 "Poverty.count")]))
```

### Enrollment (average across 2013-2018) Distribution
```{r}
school_enroll <- school %>%
  group_by(School.Name) %>%
  summarise(Avg.Enroll = mean(Total.Enrollment))
p <- school_enroll %>%
  ggplot(mapping = aes(x = Avg.Enroll)) +
  geom_histogram(fill = "lightblue") +
  ggtitle("Average Enrollment Per School") +
  xlab("Average Enrollment Count") + ylab("Count")
p + 
    scale_color_manual(name = "Statistics", values = c(mean = "red", 
                                                     `25 percentile` = "orange",
                                                     `75 percentile` = "green")) +
  geom_vline(aes(xintercept = mean(school_enroll$Avg.Enroll), color = "mean")) +
  geom_vline(aes(xintercept = quantile(school_enroll$Avg.Enroll)[2], color = "25 percentile")) +
  geom_vline(aes(xintercept = quantile(school_enroll$Avg.Enroll)[4], color = "75 percentile")) +
  theme(plot.title = element_text(hjust = 0.5, face  = "bold", size = 14))
```
After averaging the number of total enrollments for each school observed, we can generate the following histogram that shows the distribution of enrollment number of the schools. Based on the visualization, we can see that the majority of of schools (25th to 75th percentile) are clustered around the interval between 300 and 700.

### Yearly Observation Count
```{r}
p <- ggplot(data= school, aes(x = Year)) +
  geom_bar(fill = "lightblue",width =0.5) +
  ggtitle("Number of sample from different years")+
  ylab("Count") +
  geom_text(stat='count',aes(label=..count..), position = position_dodge(width = 0.9), 
            vjust = -0.4, color = "grey68") +
  theme(plot.title = element_text(hjust = 0.5, face  = "bold", size = 14))
p
```
The barplot of yearly observation describes the number of observations taken each year. From the visualization, we can see that the number of schools taken into consideration varies from time to time, meaning that there are new schools being surveyed each year. This is an indication that if we were to conduct time series analysis, it will be difficult to generalize the year-to-year pattern for those schools that were not surveyed for the whole five academic years. We further created a visualization representing the distribution of number of observations per school, as shown below.

### Number of Observations per School
```{r}
school %>%
  group_by(School.Name) %>%
  summarise(Obs.count = n()) %>%
  filter(Obs.count <= 5) %>%
  ggplot(mapping = aes(x = Obs.count)) +
  geom_bar(aes(y = stat(count/sum(count))), fill = "lightblue") +
  ggtitle("Normalized School Observation Count Histogram") +
  theme(plot.title = element_text(hjust = 0.5, face = "bold", size = 14)) +
  ylab("Proportion") + xlab("Count")

temp <- school %>%
  group_by(School.Name) %>%
  summarise(Obs.count = n())
1718/sum(table(temp$Obs.count))
```

From the visualization, we can see that not every school in the dataset is surveyed each year during the 5 academic years from 2013 to 2018.

## Project goal
In the raw dataset of `2013 - 2018 Demographic Snapshot School `, there exists several variables that worth investigating furthermore as follows:
  
  * The data set contains attributes of the **composition of different ethnicity groups** and also one variable that describes the **poverty level** of the whole school (i.e. how many students are classified as poor), thus we can investigate the relationship between ethnicity composition and school’s overall poverty level. We hypothesized that if the composition of a school includes higher proportion of minority ethnic groups, then there is a higher likelihood to have overall higher poverty level;
$$H_0: poverty\ \ level \not\propto ethnic\ \ composition$$
  $$H_a: poverty\ \ level \propto ethnic\ \ composition$$
  
  * Since the data set provides the **total number of enrolled students** as well as variables describing the **number of students from each ethnicity**, we can investigate if the total number of students correlates with the relative composition of ethnicity among the student population. We hypothesized that, as the number of students at school increases, the relative proportion of each ethnic group would become more even;
$$H_0: ethnic\ \ composition  \not\propto school\ \ population$$
  $$H_a: ethnic\ \ composition  \propto school\ \ population$$
  
  * The data set has descriptions about the **gender composition** of the student population (i.e. number of males and female students in the school). Based on the variable about the **poverty level** of the school and the information about gender composition, we can draw inferences on their interactions;

* Finally, since New York City is a quite certain place for us to narrow down our investigation, we may use the the DBN (District Borough Number) associated with each school to identify districts that the schools in each obervation belongs in. By combining the **district information** and the school’s **poverty level**, we can identify the locations where poverty level is relatively high.

## Issue with raw data
* The raw data didn't explicitly give out the district or borough where each school locates. Therefore, we have to construct location variables in order to inspect the relationship between school locations and other topics;

* In the raw data, the type of school is not included. However, based on the data shown in different grades, we can conclude whether the school is a primary school, middle school or high school. Therefore, we may use the given information to classify different level of school in data transformation part.

* The data is presented in chronological order with each school having multiple observations (i.e. five academic years, including 2013-2014, 2014-2015, 2015-2016, 2016-2017, and 2017-2018). At the same time, not every school is surveyed each year, according to the `Normalized School Observation Count Histogram` above, which means time series analysis would be difficult for the minority of schools that have incomplete 5 year observations. Thus, in order to produce generalizable results, we shall remove schools that are "incomplete".

<!--chapter:end:02-data.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Data transformation
```{r, echo=FALSE, warning=FALSE}
library(knitr)
library(tidyverse)
library(dplyr)
library(ggplot2)
library(RColorBrewer)
library(sqldf)
school = read.csv("School.csv")
```

## Removing Incomplete Schools
Before removing incomplete schools, the following table shows the number of schools for number of observation occurrences:
| Number of observations|      Number of schools       |
| --------------------- | ---------------------------- |
|          1            |             19               |
|          2            |             18               |
|          3            |             33               |
|          4            |             40               |
|          5            |            1718              |

Based on the exploratory data analysis result we obtained in the last chapter, we know that there are schools that does not have observation for each of the five academic years, which complicates analysis process if we want to conduct time series analysis. There are 1834 schools included in the data set and 1718 of them have observations for all five years, which constitutes over 93% of all schools. Thus, we choose to directly remove those schools that do not have full observations.
```{r}
school <- school %>%
  group_by(School.Name) %>%
  mutate(count = n()) %>%
  filter(count == 5) %>%
  select(-count)

school <- school %>%
  group_by(School.Name) %>%
  summarise(count = n())
table(school$count)
  
```

## Adding features
### Location of School
Since the first column specifies `DBN(District Borough Number)` of each school, we firstly use it to generate a new `location` variable. According to the DBN assigning system, the Borough is the capitalized letter in the string. `K` represents Brooklyn district, `X`represents the Bronx district, `Q` represents the Queens district, `M` represents the Manhattan district, and `R` represents the Staten Island district. During transformation, we used `str_detect` function in the `stringr` package to check for ocurrences of each Borough letter and assign the corresponding school with a location identifier in terms of the district.

After specifying the location of school, we can first get a capture of school number in different Borough among different academic years in our data source. The number of schools by year and location are shown below:

```{r}
# loc <- ggplot(data = school, aes(x = Year)) + 
#   geom_bar(stat="count",fill = "lightblue")+
#   facet_wrap(~location,ncol =5)+
#   ggtitle("Number of schools in different Borough by year") + 
#   theme(plot.title = element_text(hjust = 0.5, face  = "bold", size = 14), 
#         axis.text.x = element_text(angle = 30, vjust = 0.5))+
#    xlab("Academic Year")+
#   ylab("Number of schools")
# loc
# 
# dis <-  ggplot(data = school, aes(x = Year,fill = location)) + 
#   geom_bar(stat="count") +
#   ggtitle("2013-2018 Time Series School Count") +
#   theme(plot.title = element_text(hjust = 0.5, face  = "bold", size = 14)) + 
#   xlab("Academic Year")+
#   ylab("Number of schools") 
# dis
```

```{r}
school <- school %>% 
  mutate(location = case_when(
    str_detect(DBN, "K") == TRUE ~ "Brooklyn",
    str_detect(DBN,"X") == TRUE ~ "Bronx",
    str_detect(DBN,"Q") == TRUE ~ "Queens",
    str_detect(DBN,"M") == TRUE ~ "Manhattan",
    str_detect(DBN,"R") == TRUE ~ "Staten Island",
  ))

school %>%
  ggplot(mapping = aes(x = location)) +
  geom_bar(stat = "count", fill = "lightblue") +
  ggtitle("School Count by District") +
  xlab("Districts") + ylab("Count") +
  theme(plot.title = element_text(hjust = 0.5, face = "bold", size = 14))
```

### Type of School
As previously mentioned in Ch2, we can use the number of students enrolled in different grades to judge the type of school. In the dataset, the number of students in different grade are measured from `Grade PK` to `Grade 12`. We use the criteria below to classify the type of School.

| Type of School      | Grades Included              |
| ------------------- | ---------------------------- |
| Pre School Learning | `Grade PK`                   |
| Elementary School   | From `Grade k` to `Grade 5`  |
| Middle School       | From `Grade 6` to `Grade 8`  |
| High School         | From `Grade 9` to `Grade 12` |

```{r}
school <- rename(school, Grade.PK =Grade.PK..Half.Day...Full.Day. )
```

```{r}
school <- school %>% 
  mutate(is_preschool = case_when(
    Grade.PK > 0 ~ 1,
    T ~ 0
  )) %>% 
  mutate(is_elementary = case_when(
    Grade.K == 0 & Grade.1 == 0 & Grade.2 == 0 &
      Grade.3 == 0 & Grade.4 == 0 & Grade.5 == 0 ~ 0,
    T ~ 1
  )) %>% 
  mutate(is_middle = case_when(
    Grade.6 == 0 & Grade.7 == 0 & Grade.8 == 0 ~ 0,
    T ~ 1
  )) %>% 
  mutate(is_high = case_when(
    Grade.9 == 0 & Grade.10 == 0 & Grade.11 == 0 & Grade.12 == 0 ~ 0,
    T ~ 1
  ))
```

```{r}
count_by_type <- sqldf("select location, Year, sum(is_preschool) as pre_school,
      sum(is_elementary) as elementary,
      sum(is_middle) as middle,
      sum(is_high) as high from school group by location ,Year") %>% 
   pivot_longer(-c(location,Year),names_to ="type", values_to = "num")

count_by_type$type <- factor(count_by_type$type ,levels = c("pre_school", "elementary", "middle", "high"))

type_sch <- count_by_type %>%
  ggplot(mapping = aes(x = type, y = num, fill = location)) +
  geom_bar(stat = "identity") +
  ggtitle("School Type Distribution") +
  xlab("School Type") + ylab("Count") +
  theme(plot.title = element_text(hjust = 0.5, face  = "bold", size = 14))
type_sch
```

```{r}
# type_sch <- ggplot(count_by_type, aes(fill=type, y=num, x=Year)) + 
#     geom_bar(position="dodge", stat="identity")+
#   ggtitle("Number of schools in different type by year") + 
#   theme(plot.title = element_text(hjust = 0.5, face  = "bold", size = 14))+
#    xlab("Academic Year")+
#   ylab("Number of schools") +
#   scale_color_brewer(palette="Dark2")
# type_sch
```


<!--chapter:end:03-cleaning.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Missing values
```{r, echo=FALSE}
library(knitr)
library(ggplot2)
library(tidyverse)
library(dplyr)
library(patchwork)
NYC <- read.csv("School.csv")
```
We first check if there are any NA values in the dataset:
```{r}
print("Check if there are any NA values in the dataset:", quote = FALSE)
any(is.na(NYC))
```
However, after closer inspection, we saw that there are entries labeled with "No Data" in the column `Economic.Need.Index`. Thus, we need to treat those entries as NAs.
```{r}
NYC_na <- NYC %>%
  na_if("No Data")
print("Changing the 'No Data' variable into NA", quote = FALSE)
any(is.na(NYC_na))
print("The count of NA value is", quote = FALSE)
sum(is.na(NYC_na))
print("The percentage of NA value in 'Economic.Need.Index'", quote = FALSE)
sprintf("%0.2f%%",100*sum(is.na(NYC_na))/prod(dim(NYC_na))) #in percentage
```
## Missing Pattern plot
```{r}
plot_missing <- function(data, percent = FALSE ){
  missing_patterns <- data.frame(is.na(data)) %>%
    group_by_all() %>%
    count(name = "count", sort = TRUE) %>%
    ungroup() %>%
    remove_rownames() %>%
    rownames_to_column("number") 
  
  missing_patterns_graph<- missing_patterns %>%
    gather(key,value,-c(number,count)) %>%
    group_by(number) %>%
    mutate(complete_case = factor(ifelse(sum(value) == 0, 1, 0.5)))

  if(percent){
    missing_patterns_number <-  missing_patterns_graph %>% 
      group_by(key)%>%
      summarise(missing_number = 100*((sum(value*count))/sum(count)))%>%
      arrange(desc(missing_number)) 
  }
  if(!percent){
    missing_patterns_number <-  missing_patterns_graph %>% 
      group_by(key)%>%
      summarise(missing_number = (sum(value*count))) %>%
      arrange(desc(missing_number))
  }
  
  level_for_order <- (missing_patterns_number$key)

  g1 <- missing_patterns_graph %>%
    ggplot(aes(x = factor(key,level_for_order), 
             y = fct_rev(factor(as.numeric(number))),
             fill = value,alpha = complete_case)) +
    geom_tile(color = "white") + 
    scale_fill_manual(values = c("grey","purple")) +
    scale_alpha_manual(values = c(1,0.5)) +
    annotate("text",x = length(level_for_order)/3,
           y = missing_patterns_graph[missing_patterns_graph$complete_case == 1,]$number,
           label = "Complete Case") +
    theme(legend.position="none",axis.text.x = element_text(angle = -30, hjust = 0)) +
    xlab("variable")+
    ylab("missing pattern")

   
  g2 <- missing_patterns %>% 
    group_by(number)%>%
    ggplot(aes(x = reorder(number,count),y = count)) +
    geom_bar(stat="identity") + 
    ylab("row count")+
    coord_flip()+
    theme(axis.title.y=element_blank()) 
 

  g3 <- ggplot(missing_patterns_number,
               aes(x = reorder(key,-missing_number),y = missing_number)) +
    geom_bar(stat="identity") +
    theme(axis.title.x=element_blank(),axis.title.y = element_text(size = 8),axis.text.x = element_text(angle = -30, hjust = 0)) +
    ggtitle("Missing value patterns")

  
  if(percent){
    g3 <- g3 +  ylab("% rows missing") + ylim(0,100)
  }else{
    g3 <- g3 +  ylab("num rows missing")
  }

  g3 + plot_spacer() + g1 +g2+ plot_layout(widths = c(5, 2), 
                                           heights = unit(c(2, 5), c('cm', 'null')))
}
```
Given the shear size of the dataset, it is hard to visualize missing value pattern of the whole dataset, thus, we can sample from the whole data set and visualize the missing pattern:
```{r}
set.seed(1234567)
# case1
row_ind <- sample(1:nrow(NYC_na), 200)
col_ind <- sample(1:ncol(NYC_na), 10)
new_NYC <- NYC_na[row_ind, col_ind]
plot_missing(new_NYC)
# case2
row_ind <- sample(1:nrow(NYC_na), 200)
col_ind <- sample(1:ncol(NYC_na), 10)
new_NYC <- NYC_na[row_ind, col_ind]
plot_missing(new_NYC)
# case3
row_ind <- sample(1:nrow(NYC_na), 200)
col_ind <- sample(1:ncol(NYC_na), 10)
new_NYC <- NYC_na[row_ind, col_ind]
plot_missing(new_NYC)
```
After trying few cases of missing pattern combinations, it is really rare to find a case that have a pattern. This is because that the data itself has a really large size, which is 8972 rows by 39 columns, while there's only 1730 missing entries, with a missing value rate less than 0.5%. Thus, we can say that the data set is overall complete.

<!--chapter:end:04-missing.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Results

<!--chapter:end:05-results.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Interactive component



<!--chapter:end:06-interactive.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Conclusion


<!--chapter:end:07-conclusion.Rmd-->

